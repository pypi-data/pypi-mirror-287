Metadata-Version: 2.1
Name: clovers
Version: 0.1.14
Summary: 
Author: KarisAya
Author-email: 1048827424@qq.com
Requires-Python: >=3.12,<4.0
Classifier: Programming Language :: Python :: 3
Provides-Extra: all
Provides-Extra: linecard
Provides-Extra: tools
Requires-Dist: fonttools (>=4.51.0,<5.0.0) ; extra == "linecard" or extra == "all"
Requires-Dist: httpx (>=0.27.0,<0.28.0) ; extra == "tools" or extra == "all"
Requires-Dist: matplotlib (>=3.8.4,<4.0.0) ; extra == "linecard" or extra == "all"
Requires-Dist: numpy (>=1.26.4,<2.0.0) ; extra == "tools" or extra == "all"
Requires-Dist: pillow (>=10.3.0,<11.0.0) ; extra == "linecard" or extra == "all"
Requires-Dist: toml (>=0.10.2,<0.11.0)
Description-Content-Type: text/markdown

# CLOVERS

_âœ¨ è‡ªå®šä¹‰çš„èŠå¤©å¹³å°å¼‚æ­¥æœºå™¨äººæŒ‡ä»¤-å“åº”æ’ä»¶æ¡†æ¶ âœ¨_

<div align="center">
<img src="https://img.shields.io/badge/python-3.12+-blue.svg" alt="python">
<a href="./LICENSE">
  <img src="https://img.shields.io/github/license/KarisAya/clovers.svg" alt="license">
</a>
<a href="https://pypi.python.org/pypi/clovers">
  <img src="https://img.shields.io/pypi/v/clovers.svg" alt="pypi">
</a>
<a href="https://pypi.python.org/pypi/clovers">
  <img src="https://img.shields.io/pypi/dm/clovers" alt="pypi download">
</a>
</div>

## ğŸ’¿ å®‰è£…

<details open>
<summary>pip</summary>

```bash
pip install clovers
```

</details>

<details>
<summary>poetry</summary>

```bash
poetry add clovers
```

</details>

## æ’ä»¶è·å–é…ç½®

é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨ä¸€ä¸ª toml æ–‡ä»¶é‡Œï¼Œæ–‡ä»¶ç”±ä½ æŒ‡å®š

ä¸‹é¢æ˜¯é…ç½®ä¸€ä¸ªä¾‹å­

clovers.toml

```toml
[nonebot_plugin_clovers]
plugins_path = "./clovers/plugins"
plugins_list = ["clovers_apscheduler"]
```

æ„å‘³ç€ clovers ä¼šåŠ è½½`./clovers/plugins`æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ä½œä¸ºæ’ä»¶ï¼ˆæ’é™¤`_`å¼€å¤´çš„æ–‡ä»¶ï¼‰

æ’ä»¶è·å–çš„é…ç½®ä¼šæ˜¯ä¸€ä¸ªå­—å…¸ã€‚

ä¸ºä¾¿äºæ’ä»¶é—´çš„é…ç½®äº’ç›¸è·å–ï¼Œå»ºè®®åœ¨æ’ä»¶ä¸­ä½¿ç”¨ç±»ä¼¼ä¸‹é¢çš„ä»£ç åŠ è½½é…ç½®

```python
from clovers.core.config import config as clovers_config
config_key = __package__ # æˆ–è€…ä½ è‡ªå®šä¹‰çš„ä»»ä½•key
default_config = {"some_config_name":"some_config_value"}
# å„ç§æ–¹æ³•è·å–é…ç½®
config_data = clovers_config.get(config_key, {})
default_config.update(config_data)
# æŠŠé…ç½®å­˜å›æ€»é…ç½®
clovers_config[config_key] = config_data
```

å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸è¿™ä¹ˆåš

## å…³äºæ’ä»¶

ä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡æ¿

```python
from clovers.core.config import config as clovers_config
from clovers.core.plugin import Plugin, Event
from .config import Config

# è·å–ä½ çš„é…ç½®
config_key = __package__
config_data = Config.parse_obj(clovers_config.get(config_key, {}))
clovers_config[config_key] = config_data.dict()

plugin = Plugin()

# å¯åŠ¨æ—¶çš„ä»»åŠ¡
@plugin.startup
async def _():
    pass

# å…³é—­æ—¶çš„ä»»åŠ¡
@plugin.shutdown
async def _():
    pass


# æŒ‡ä»¤-å“åº”ä»»åŠ¡
@plugin.handle({"æµ‹è¯•"})
async def _(event: Event):
    pass

__plugin__ = plugin
```

æ’ä»¶åŠ è½½å™¨ä¼šå°è¯•è·å–ä½ çš„æ¨¡å—çš„`__plugin__`å±æ€§ï¼Œå¹¶ä½œä¸ºæ’ä»¶æ”¾è¿›é€‚é…å™¨çš„æ’ä»¶åˆ—è¡¨é‡Œ

å¦‚æœä½ æƒ³ç¼–å†™æ’ä»¶çš„æ’ä»¶ï¼Œä¹Ÿå¯ä»¥ä¸å®šä¹‰`__plugin__`å±æ€§,ä½†æ˜¯ä¸€èˆ¬ä½ éœ€è¦ä½¿ç”¨å…¶ä»–æ’ä»¶çš„`__plugin__`å±æ€§

```python
from some_plugin import __plugin__ as plugin

# do something
@plugin.handle({"å…¶ä»–æµ‹è¯•"})
async def _(event: Event):
    pass
```

### æŒ‡ä»¤-å“åº”ä»»åŠ¡è·å–å¹³å°å‚æ•°

å¦‚æœä½ åœ¨æ’ä»¶ä¸­éœ€è¦è·å–ä¸€äº›å¹³å°å‚æ•°ï¼Œé‚£ä¹ˆéœ€è¦åœ¨æ³¨å†Œ plugin.handle æ—¶äº‹å…ˆå£°æ˜éœ€è¦çš„å‚æ•°

```python
@plugin.handle({"æµ‹è¯•"},{"user_id","others"})
async def _(event: Event):
    print(event.kwargs["user_id"])
    print(event.kwargs["others"])
    print(event.kwargs["extra"]) # KeyError
```

é€‚é…å™¨æ–¹æ³•ä¼šæ ¹æ®ä½ éœ€è¦çš„å‚æ•°æ„å»º event.kwargs

æœ‰æ—¶ä¸ºäº†ä¼˜åŒ–ï¼Œä½ ä¸éœ€è¦åœ¨æ¯æ¬¡æ‰§è¡Œä»»åŠ¡æ—¶éƒ½ä½¿ç”¨æŸä¸ªå‚æ•°ï¼Œä½ ä¹Ÿå¯ä»¥å£°æ˜è·å–è¿™ä¸ªå‚æ•°çš„æ–¹æ³•ï¼Œåœ¨ä»»åŠ¡ä¸­è·å–ã€‚

å£°æ˜è·å–å‚æ•°çš„æ–¹æ³•è·å–åˆ°çš„å€¼æ˜¯ä¸€ä¸ªä¸éœ€è¦å‚æ•°çš„å¼‚æ­¥å‡½æ•°ï¼Œå­˜åœ¨ get_kwargs çš„ç›¸åº”å­—æ®µé‡Œã€‚

å¼‚æ­¥å‡½æ•°çš„è¿”å›å€¼ä¸å‚æ•°å£°æ˜ä¸­è·å–çš„å€¼å®Œå…¨ç›¸åŒã€‚

```python
@plugin.handle({"æµ‹è¯•"},{"user_id"}, get_extra_args = ["others"])
async def _(event: Event):
    print(event.kwargs["user_id"])
    print(event.kwargs["others"]) # function
    others = await event.kwargs["others"]()
```

### æŒ‡ä»¤-å“åº”ä»»åŠ¡ä¸­çš„ event

event æ˜¯ä½ åœ¨æŒ‡ä»¤-å“åº”ä»»åŠ¡çš„å‡½æ•°ä¸­å”¯ä¸€è·å¾—çš„å‚æ•°ï¼Œä½ éœ€è¦çš„æ‰€æœ‰ä¸œè¥¿éƒ½åœ¨ event é‡Œ

`raw_command` è§¦å‘æœ¬æ¬¡å“åº”çš„åŸå§‹å­—ç¬¦ä¸²
`args` è§£æçš„å‚æ•°åˆ—è¡¨

```python
#ä½¿ç”¨ "ä½ å¥½ä¸–ç•Œ" è§¦å‘å“åº”
@plugin.handle({"ä½ å¥½"})
async def _(event: Event):
    print(event.raw_command) # "ä½ å¥½ä¸–ç•Œ"
    print(event.args) # ["ä¸–ç•Œ"]
```

å¦‚æœä½ ä¸æƒ³ä½¿ç”¨åŸå§‹çš„ event,ä½ ä¹Ÿå¯ä»¥è‡ªå»º event ç±»,ç„¶ååœ¨åˆ›å»º plugin å®ä¾‹æ—¶æ³¨å…¥ build_event æ–¹æ³•ã€‚

```python
from clovers.core.plugin import Plugin
class Event:
    def __init__(self, event: CloversEvent):
        self.event: CloversEvent = event

    @property
    def raw_command(self):
        return self.event.raw_command

    @property
    def args(self):
        return self.event.args

    @property
    def user_id(self) -> str:
        return self.event.kwargs["user_id"]

plugin = Plugin(build_event=lambda event: Event(event))

@plugin.handle({"æµ‹è¯•"},{"user_id"})
async def _(event: Event):
    print(event.user_id) # "123456"
```

### æ’ä»¶çš„å“åº”

å“åº”çš„æ ¼å¼åº”è¯¥æ˜¯ clovers.core.plugin.Result ç±»

`send_method` æ§åˆ¶é€‚é…å™¨æ–¹æ³•ç”¨ä»€ä¹ˆæ–¹å¼å‘é€ä½ çš„æ•°æ®

`data` æ˜¯è¦å‘é€çš„åŸå§‹æ•°æ®

æ¥ä¸‹æ¥çš„ç¤ºä¾‹æ˜¯æŒ‡ä»¤ä¸º "æµ‹è¯•" å›åº” "ä½ å¥½" çš„ æ’ä»¶æŒ‡ä»¤-å“åº”ä»»åŠ¡

```python
@plugin.handle({"æµ‹è¯•"})
async def _(event: Event):
    return Result("text", "ä½ å¥½")
```

å½“ç„¶å¦‚æœä½ è®¤ä¸ºè¿™æ ·å¤ªè¿‡ç¹çï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ build_result æ–¹æ³•

```python
from clovers.core.plugin import Plugin
def build_result(result):
    if isinstance(result, str):
        return Result("text", result)
    if isinstance(result, BytesIO):
        return Result("image", result)
    if isinstance(result, AnyTypeYouNeed):
        return Result("any_method_you_want", result)
    return result

plugin = Plugin(build_result=build_result)

@plugin.handle(["æµ‹è¯•"])
async def _(event: Event):
    return "ä½ å¥½"
```

### å…³äºæ’ä»¶çš„å…¶ä»–åŠŸèƒ½

**ä¸´æ—¶ä»»æ„è§¦å‘ä»»åŠ¡**

```python
@plugin.temp_handle("temp_handle1", 30, ["user_id", "group_id"])
async def _(event: Event, finish):
  if i_should_finish:
    finish()
```

éœ€è¦çš„ä¸‰ä¸ªå‚æ•°

`key` ä¸´æ—¶ä»»åŠ¡ key å¦‚æœè¿™ä¸ª key è¢«æ³¨å†Œè¿‡ï¼Œå¹¶ä¸”æ²¡æœ‰è¶…æ—¶ä¹Ÿæ²¡æœ‰ç»“æŸï¼Œé‚£ä¹ˆä¹‹å‰çš„ä»»åŠ¡ä¼šè¢«ä¸‹é¢çš„ä»»åŠ¡è¦†ç›–

`extra_args` éœ€è¦çš„å¹³å°å‚æ•°

`timeout` ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

temp_handle ä¼šè¢«ä»»æ„æ¶ˆæ¯è§¦å‘ï¼Œè¯·åœ¨ä»»åŠ¡å†…è‡ªå®šä¹‰æ£€æŸ¥è§„åˆ™ã€‚

temp_handle ä»»åŠ¡é™¤äº† eventï¼Œä½ è¿˜ä¼šè·å¾—ä¸€ä¸ª Callable å‚æ•° finishï¼Œå®ƒçš„åŠŸèƒ½æ˜¯ç»“æŸæœ¬ä»»åŠ¡ã€‚å¦‚æœä½ ä¸ç»“æŸï¼Œåœ¨ä¸´æ—¶ä»»åŠ¡è¶…æ—¶å‰æ¯æ¬¡æ¶ˆæ¯éƒ½ä¼šè§¦å‘ã€‚

**å…³äº handle ä»»åŠ¡çš„æŒ‡ä»¤æ ¼å¼å’Œå‚æ•°åˆ—è¡¨**

set æ ¼å¼ï¼šåˆé›†å†…çš„æŒ‡ä»¤éƒ½ä¼šè§¦å‘æ’ä»¶

```python
#è§¦å‘æŒ‡ä»¤ä¸º"ä½ å¥½ ä¸–ç•Œ"æ—¶ï¼Œè¾“å‡º ["ä¸–ç•Œ"]
#è§¦å‘æŒ‡ä»¤ä¸º"hello1 world with extra args"æ—¶ï¼Œè¾“å‡º ["1","world","with","extra","args"]
@plugin.handle({"ä½ å¥½","hello"})
async def _(event: Event):
    print(event.args)
```

å­—ç¬¦ä¸²æ ¼å¼ï¼šæ­£åˆ™åŒ¹é…

å¦‚æœ handle çš„æŒ‡ä»¤å‚æ•°æ˜¯å­—ç¬¦ä¸²é‚£ä¹ˆå®ƒä¼šè¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œargs ä¼šæ˜¯æ­£åˆ™å­—ç¬¦ä¸²ä¸­çš„ group åˆ—è¡¨

```python
#è§¦å‘æŒ‡ä»¤ä¸º"i love you"æ—¶ï¼Œè¾“å‡º ["i "," you"] ä½¿ç”¨æ—¶æ³¨æ„å»æ‰å‚æ•°é‡Œçš„ç©ºæ ¼
#è§¦å‘æŒ‡ä»¤ä¸º"you love me"æ—¶,è¾“å‡º ["you "," me"]
#è§¦å‘æŒ‡ä»¤ä¸º"make love"æ—¶,è¾“å‡º ["make ", None]
@plugin.handle(r"^(.+)love(.*)")
async def _(event: Event):
    print(event.args)
```

## å…³äºé€‚é…å™¨

åˆ›å»ºä¸€ä¸ªé€‚é…å™¨

```python
adapter = Adapter()
```

~~åˆ›å»ºå¥½äº†~~

ä¸€ä¸ªé€‚é…å™¨å¯ä»¥æœ‰å¤šä¸ªé€‚é…å™¨æ–¹æ³•

é€‚é…å™¨çš„æ‰€æœ‰æ–¹æ³•éƒ½éœ€è¦è‡ªå·±å†™

å¦‚æœä½ æƒ³ä½¿ç”¨ clovers æ¡†æ¶ï¼Œéœ€è¦ä½¿ç”¨ä½ æ¥æ”¶åˆ°çš„çº¯æ–‡æœ¬æ¶ˆæ¯è§¦å‘é€‚é…å™¨å“åº”

åƒè¿™æ ·

```python
#å‡è®¾ä½ åœ¨ä¸€ä¸ªå¾ªç¯é‡Œä¸æ–­è½®è¯¢æ”¶å‘æ¶ˆæ¯ç«¯æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
while True:
    command = received_plain_text()
    if command:
        await adapter.response(adapter_key, command, **kwargs)
```

`adapter_key` é€‚é…å™¨æ–¹æ³•æŒ‡å®šçš„ key
`kwargs` é€‚é…å™¨æ–¹æ³•éœ€è¦çš„æ‰€æœ‰å‚æ•°

### é€‚é…å™¨æ–¹æ³•

è·å–å‚æ•°ï¼Œå‘é€ä¿¡æ¯çš„æ–¹æ³•ã€‚é‡Œé¢æ‰€æœ‰çš„æ–¹æ³•éƒ½éœ€è¦è‡ªå·±å†™

å‘é€ä¿¡æ¯ï¼Œè·å–å‚æ•°

```python
# å‡å¦‚æ”¶å‘ä¿¡æ¯æ¡†æ¶æä¾›äº†å¦‚ä¸‹æ–¹æ³•

# send_plain_text(text:str)å‘é€çº¯æ–‡æœ¬

method = AdapterMethod()
@method.send("text")
async def _(message: str):
    send_plain_text(message)

# send_image(image:bytes) å‘é€å›¾ç‰‡ï¼Œä½†æ˜¯éœ€è¦responseçš„å‚æ•°

@method.send("image")
async def _(message: bytes,send_image):
    send_image(message)

# senderå‘é€æ¶ˆæ¯çš„ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡responseçš„å‚æ•°ä¼ å…¥
# å‡è®¾æœ‰ sender.user_id å±æ€§ä¸ºè¯¥ç”¨æˆ·uid
@method.kwarg("user_id")
async def _(sender):
    return sender.user_id

# æ³¨å…¥é€‚é…å™¨æ–¹æ³•
adapter.methods["my_adapter_method"] = method
```

ä½¿ç”¨ä¸Šè¿°é€‚é…å™¨

ä½ çš„ `Result("text", "ä½ å¥½")` ä¼šä½¿ç”¨ send_plain_text å‘é€

ä½ çš„æŒ‡ä»¤å“åº”ä»»åŠ¡è·å–å¹³å°å‚æ•°çš„ `"user_id"` å°±æ˜¯ sender.user_id

### ä½¿ç”¨æ’ä»¶åŠ è½½å™¨ PluginLoader å‘é€‚é…å™¨æ³¨å…¥æ’ä»¶

```python
loader = PluginLoader(plugins_path, plugins_list)
adapter.plugins = loader.plugins
```

`plugins_list` æ’ä»¶ååˆ—è¡¨,ä¾‹å¦‚["plugin1","plugin2"]ã€‚ä» python lib è·¯å¾„ä¸‹çš„åŒ…ååŠ è½½æ’ä»¶

`plugins_path` æ’ä»¶æ–‡ä»¶å¤¹ï¼ŒåŠ è½½æ”¹è·¯å¾„ä¸‹çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ä½œä¸ºæ’ä»¶ï¼ˆæ’é™¤`_`å¼€å¤´çš„æ–‡ä»¶ï¼‰

æˆ–è€…

```python
plugin = PluginLoader.load("plugin1")
if not plugin is None:
    adapter.plugins.append(plugin)
```

### å¼€å§‹ï¼Œç»“æŸä»»åŠ¡

ä¸€äº›æ’ä»¶ä¼šæ³¨å†Œä¸€äº›å¼€å§‹æ—¶ï¼Œç»“æŸæ—¶è¿è¡Œçš„ä»»åŠ¡

æ‰€ä»¥ä½ éœ€è¦åœ¨å¼€å§‹æ—¶ï¼Œæˆ–ç»“æŸæ—¶æ‰§è¡Œ

```python
asyncio.create_task(adapter.startup)
asyncio.create_task(adapter.shutdown)
```

æˆ–ç±»ä¼¼ä½œç”¨çš„ä»£ç 

## ğŸ“ è”ç³»

å¦‚æœ‰å»ºè®®ï¼Œbug åé¦ˆç­‰å¯ä»¥åŠ ç¾¤

æœºå™¨äºº bug ç ”ç©¶ä¸­å¿ƒï¼ˆé—²èŠç¾¤ï¼‰ 744751179

æ°¸æ’ä¹‹åŸï¼ˆæµ‹è¯•ç¾¤ï¼‰ 724024810

![ç¾¤å·](https://github.com/KarisAya/clovers/blob/master/%E9%99%84%E4%BB%B6/qrcode_1676538742221.jpg)

## ğŸ’¡ é¸£è°¢

- [nonebot2](https://github.com/nonebot/nonebot2) è·¨å¹³å° Python å¼‚æ­¥èŠå¤©æœºå™¨äººæ¡†æ¶ ~~éœ€æ±‚éƒ½æ˜¯åŸºäºè¿™ä¸ªå†™çš„~~

