{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <h2>Past Invoices (<span id="past-invoices-count-header"></span>)</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="past-invoices-data-table">
            <thead class="thead-light">
            <tr>
                <th scope="col">Number</th>
                <th scope="col">Date</th>
                <th scope="col">Due Date</th>
                <th scope="col">Reference Number</th>
                <th scope="col">Customer Name</th>
                <th scope="col">Description</th>
                <th scope="col">Total Amount</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody id="past-invoices-data-table-body">

            </tbody>
        </table>
    </div>
    <nav class="d-flex justify-content-center" aria-label="Page navigation">
        <ul class="pagination" id="pagination">
            <!-- Pagination links will be populated here -->
        </ul>
    </nav>
</div>

<script type="text/javascript">
function refreshData(page) {
    $.ajax({
        type: 'GET',
        url: '/past_invoices?page=' + page,
        success: function(data) {
            // Populate past invoices section
            const pastInvoicesDataTable = document.getElementById('past-invoices-data-table').getElementsByTagName('tbody')[0];
            const tableBody = $('#past-invoices-data-table-body');
            const pagination = $('#pagination');

            // clear all the old rows first
            tableBody.empty();

            // Repopulate the table
            for (const [entry, values] of Object.entries(data['past_invoices'])) {
                    const row = pastInvoicesDataTable.insertRow();

                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    const cell3 = row.insertCell(2);
                    const cell4 = row.insertCell(3);
                    const cell5 = row.insertCell(4);
                    const cell6 = row.insertCell(5);
                    const cell7 = row.insertCell(6);
                    const cell8 = row.insertCell(7);
                    const cell9 = row.insertCell(8);

                    cell1.innerHTML = values.invoice_number;
                    cell2.innerHTML = values.invoice_date;
                    cell3.innerHTML = values.due_date;
                    cell4.innerHTML = values.reference_number;
                    cell5.innerHTML = values.customer_name;
                    cell6.innerHTML = values.description;
                    cell7.innerHTML = values.total_amount + ' ' + values.currency_symbol;
                    if (values.status == 1) {
                        cell8.innerHTML = '<div class="bg-success text-light text-center">Paid</div>';
                    } else if (values.status == 2) {
                        cell8.innerHTML = '<div class="bg-danger text-light text-center">Canceled</div>';
                    }
                    cell9.innerHTML = `<button type="button" class="btn btn-primary view-invoice-button me-1" data-id="${values.id}"><i class="bi bi-zoom-in"></i></button><button type="button" class="btn btn-primary print-invoice-button" data-id="${values.id}"><i class="bi bi-printer"></i></button>`;
            }

            // Handle view invoice button clicks
            $('.view-invoice-button').on('click', function () {
                const invoice_id = $(this).data('id');

                loadNewTabWithInvoiceID(invoice_id, false);
            });

            // Handle print invoice button clicks
            $('.print-invoice-button').on('click', function () {
                const invoice_id = $(this).data('id');

                loadNewTabWithInvoiceID(invoice_id, true);
            });

            pagination.empty();
            for (let i = 1; i <= parseInt(data['total_number_of_pages']); i++) {
                let li = `<li class="page-item ${i === page ? 'highlighted' : ''}">`;
                li += `<a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                pagination.append(li);
            }

            // Handle pagination click
            pagination.on('click', 'a', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                refreshData(page);
            });

            $('#past-invoices-count').html(parseInt(data['total_number_of_invoices']));
            $('#past-invoices-count-header').html(parseInt(data['total_number_of_invoices']));
        }
    });

    $.ajax({
        url: '/past_invoices_count',
        method: 'GET',
        success: function(response) {
            $('#past_invoices_count').text(String(response));
        },
        error: function (error) {
            $('#loading_modal').modal('hide');
            notify_warning('Error while trying to retrieve past invoices count! Reason: ' + error);
        }
    });

    $.ajax({
        url: '/past_proposals_count',
        method: 'GET',
        success: function(response) {
            $('#past_proposals_count').text(String(response));
        },
        error: function (error) {
            $('#loading_modal').modal('hide');
            notify_warning('Error while trying to retrieve past proposals count! Reason: ' + error);
        }
    });

    // hide the loading modal
    $('#loading_modal').modal('hide');
}

$(document).ready(function() {
    $('#loading_modal').modal('show');

    setTimeout(() => {
        refreshData(1);
    }, 500);
});

</script>
{% endblock %}