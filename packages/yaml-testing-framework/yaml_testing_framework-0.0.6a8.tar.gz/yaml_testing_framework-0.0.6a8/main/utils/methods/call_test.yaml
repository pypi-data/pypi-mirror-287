TODO:
- Finish test for the main function. May require a spy.
- Add flag for silent logging in cases where an exception is the expected output


help:
- https://stackoverflow.com/questions/5218895/python-nested-functions-variable-scoping


resources:
- &CHECKS
  resource: ${YAML_TESTING_FRAMEWORK_ROOT_DIR}/checks/app.py
- &RESOURCE
  resource: ${YAML_TESTING_FRAMEWORK_ROOT_DIR}/main/utils/methods/resource.py


tests:
- function: main
  description: >
    Returns of the result of calling a method with or without arguments
  tests:
  - description: Undefined arguments
    arguments: {}
    checks:
    - method: check_error
      << : *CHECKS
      field: exception
      expected: TypeError
    - method: check_error
      << : *CHECKS
      field: output
      expected: TypeError
  - description: Call method and unpack list arguments.
    cast_arguments:
    - method: get_function
      << : *RESOURCE
      field: method
    arguments:
      arguments: [1, 1]
      method: add
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        exception: null
        output: 2
  - description: Call method, no unpacking
    cast_arguments:
    - method: get_function
      << : *RESOURCE
      field: method
    arguments:
      method: sum_
      arguments: 
        values: [2, 2]
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        output: 4
        exception: null
  - description: Call method and unpack mapping arguments.
    cast_arguments:
    - method: get_function
      << : *RESOURCE
      field: method
    arguments:
      arguments:
        a: 0
        b: 0
      method: add
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        exception: null
        output: 0
- function: is_coroutine
  description: Returns True if an object is a coroutine and False otherwise
  cast_arguments:
  - method: get_method
    << : *RESOURCE
    field: object
  tests:
  - description: Object is undefined
    arguments:
      object: null
    checks:
    - method: check_equals
      << : *CHECKS
      expected: False
  - description: Object is callable
    arguments:
      object: callable_function
    checks:
    - method: check_equals
      << : *CHECKS
      expected: False
  - description: Object is awaitable
    arguments:
      object: awaitable_function
    checks:
    - method: check_equals
      << : *CHECKS
      expected: True
- function: get_task_from_event_loop
  description: Returns the output of an awaitable or callable function
  cast_arguments:
  - method: get_task
    << : *RESOURCE
    field: task
  tests:
  - description: Task is undefined
    arguments:
      task: null
    checks:
    - method: check_equals
      << : *CHECKS
      expected: null
  - description: Task is callable output
    arguments:
      task: callable_function
    checks:
    - method: check_equals
      << : *CHECKS
      expected: callable_output
  - description: Task is awaitable output
    arguments:
      task: awaitable_function
    checks:
    - method: check_equals
      << : *CHECKS
      expected: awaitable_output
- function: caller_wrapper
  description: Decorator that handles exceptions and formats output from "call" handlers
  cast_arguments:
  - field: method
    << : *RESOURCE
    method: get_method
  tests:
  - arguments:
      method: greetings
    checks:
    - method: check_equals
      << : *CHECKS
      field: __wrapped__.__name__
      expected: greetings
    - method: check_sns
      << : *CHECKS
      cast_output:
      - method: call_output
        << : *RESOURCE
      expected:
        output: Hello World
        exception: null
- function: unpack_mapping
  description: Returns output from passing an unpacked mapping to a method
  cast_arguments:
  - field: method
    << : *RESOURCE
    method: get_method
  tests:
  - description: Argument is a mapping
    arguments:
      arguments:
        a: 0
        b: 0
      method: add
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        output: 0
        exception: null
  - description: Argument is a list
    arguments:
      arguments: [0, 0]
      method: add
    checks:
    - method: check_error
      << : *CHECKS
      field: output
      expected: TypeError
    - method: check_error
      << : *CHECKS
      field: exception
      expected: TypeError
- function: unpack_list
  description: Returns output from passing an unpacked list or tuple to a method
  cast_arguments:
  - field: method
    << : *RESOURCE
    method: get_method
  tests:
  - description: Argument is a list
    arguments:
      arguments:
      - 0
      - 0
      method: add
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        output: 0
        exception: null
  - description: Argument is a mapping
    arguments:
      arguments:
        a: 0
        b: 0
      method: add
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        output: ab
        exception: null
  - description: Argument has too many values
    arguments:
      arguments:
        a: 0
        b: 0
        c: 0
      method: add
    checks:
    - method: check_error
      << : *CHECKS
      field: output
      expected: TypeError
    - method: check_error
      << : *CHECKS
      field: exception
      expected: TypeError
- function: pack_any
  description: Returns output from calling function with packed arguments
  cast_arguments:
  - field: method
    << : *RESOURCE
    method: get_method
  tests:
  - description: Argument is a mapping
    arguments:
      arguments:
        a: 0
        b: 0
      method: sum_
    checks:
    - method: check_error
      << : *CHECKS
      field: output
      expected: TypeError
    - method: check_error
      << : *CHECKS
      field: exception
      expected: TypeError
  - description: Argument is a list
    arguments:
      arguments:
      - 0
      - 0
      method: sum_
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        output: 0
        exception: null
- function: do_nothing
  description: Does nothing
  tests:
  - arguments: {}
    checks:
    - method: check_equals
      << : *CHECKS
      expected: null
  - arguments:
      field: value
    checks:
    - method: check_equals
      << : *CHECKS
      expected: null
- function: get_handlers
  description: >
    Returns handlers or methods used to call a function with packed or unpacked
    arguments
  tests:
  - description: Arguments is not a mapping or list
    arguments:
      arguments: null
    checks:
    - method: check_length
      << : *CHECKS
      expected: 2
    - method: check_type
      << : *CHECKS
      expected: list
    - method: check_equals
      << : *CHECKS
      cast_output:
      - method: list_methods_to_list_strings
        << : *RESOURCE
      expected:
      - unpack_list
      - pack_any
  - description: Arguments is a mapping
    arguments:
      arguments: {}
    checks:
    - method: check_length
      << : *CHECKS
      expected: 2
    - method: check_equals
      << : *CHECKS
      cast_output:
      - method: list_methods_to_list_strings
        << : *RESOURCE
      expected:
      - unpack_mapping
      - pack_any
  - description: Arguments is a list
    arguments:
      arguments: []
    checks:
    - method: check_length
      << : *CHECKS
      expected: 2
    - method: check_equals
      << : *CHECKS
      cast_output:
      - method: list_methods_to_list_strings
        << : *RESOURCE
      expected:
      - unpack_list
      - pack_any
- function: call_handlers
  description: >
    Returns the first result from the calling the method using a handler where
    the result does not produce an exception. If all handlers produce errors return the
    first error produced.
  cast_arguments:
  - method: get_method
    << : *RESOURCE
    field: method
  - method: get_handlers
    << : *RESOURCE
    field: handlers
  tests:
  - description: Handlers is empty list
    arguments:
      arguments: {}
      method: add
      handlers: []
    checks:
    - method: check_error
      << : *CHECKS
      expected: IndexError
  - description: Single handler
    arguments:
      arguments:
      - 1
      - 1
      method: sum_
      handlers:
      - pack_any
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        output: 2
        exception: null
  - description: Mapping and any handlers
    arguments:
      arguments:
        a: 1
        b: 1
      method: add
      handlers:
      - unpack_mapping
      - pack_any
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        output: 2
        exception: null
  - description: list and any handlers
    arguments:
      arguments: 1
      method: sum_
      handlers:
      - unpack_list
      - pack_any
    checks:
    - method: check_error
      << : *CHECKS
      field: output
      expected: TypeError
  - description: list and any handlers
    arguments:
      arguments:
      - 1
      - 1
      method: sum_
      handlers:
      - unpack_list
      - pack_any
    checks:
    - method: check_sns
      << : *CHECKS
      expected:
        output: 2
        exception: null
