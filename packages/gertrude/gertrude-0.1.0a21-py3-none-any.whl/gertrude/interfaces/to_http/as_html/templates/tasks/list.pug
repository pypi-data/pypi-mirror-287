//- Gertrude --- GTD done right
//- Copyright © 2023, 2024 Tanguy Le Carrour <tanguy@bioneland.org>
//-
//- This program is free software: you can redistribute it and/or modify
//- it under the terms of the GNU Affero General Public License as
//- published by the Free Software Foundation, either version 3 of the
//- License, or (at your option) any later version.
//-
//- This program is distributed in the hope that it will be useful,
//- but WITHOUT ANY WARRANTY; without even the implied warranty of
//- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//- GNU Affero General Public License for more details.
//-
//- You should have received a copy of the GNU Affero General Public License
//- along with this program. If not, see <http://www.gnu.org/licenses/>.

extends layout

block title
  title= _(title)

block content
  section.section
    .container
      h1.title= _(title)

      block list
        if "next" in current_path
          - var refresh_url = url_for("tasks.next_list")
        else
          - var refresh_url = url_for("tasks.index_list", **current_args)

        //- TODO: also trigger for `TaskUpdated` (comma doesn’t work?!)
        //- INFO: delay introduced to wait for the projection to be updated.
        #list.box(
          hx-trigger="TaskCaptured from:body delay:10ms"
          hx-get=refresh_url
          hx-swap="outerHTML settle:0.5s"
          style="padding: 0"
        )
          if tasks
            ul.list-of-tasks
              each task in tasks
                li: a(
                  href=url_for("tasks.display", id=task.id)
                  title=_("pages-mixins-list-of-tasks-display-title")
                )
                  - var project = projects_by_id[task.assigned_to]
                  if project
                    span.project-tag= project.short_name
                  else
                    span.no-project-tag -

                  span= task.title

                  span.task-tags
                    if task.scheduled_on
                      - var classes = "due-date-tag" if task.is_due else "date-tag"
                      span(class=classes)= task.scheduled_on
          else
            article.message.is-success
              - var next = url_for("tasks.next")
              - var delegated = url_for("tasks.index", state="delegated")
              - var incubated = url_for("tasks.index", state="incubated")
              - var scheduled = url_for("tasks.index", state="scheduled")
              - var projects = url_for("projects.index")
              .message-body!= _(message, url_next=next, url_delegated=delegated, url_incubated=incubated, url_scheduled=scheduled, url_projects=projects)
