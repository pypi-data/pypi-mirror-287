name: "Build and push Docker Image to GPASLTD OCIR"
run-name: "${{ github.repository }} release build"
concurrency: "${{ github.repository }}-release"

on:
  release:
    types: [ published ]

env:
  REGISTRY: "lhr.ocir.io/lr3yhdniv6gu"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository ${{ github.repository }}
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract repository name
        id: repo-name
        # Strip the owner and `/` from the repo env var
        run: echo "REPOSITORY_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - name: Login to OCIR in gpasltd
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.OCI_USERNAME_GPASLTD }}
          password: ${{ secrets.OCI_TOKEN_GPASLTD }}

      - name: Build and push to gpasltd OCR
        id: build_and_push_gpas_ltd
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          file: Dockerfile
          tags:
            "${{ env.REGISTRY }}/${{ env.REPOSITORY_NAME }}:${{ github.event.release.tag_name }}"
